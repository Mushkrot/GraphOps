# GraphOps Intelligence Platform â€” Docker Compose
# All data volumes mount to /ai/GraphOps/docker-data/ for portability
# Network: graphops-net (bridge)

services:
  nebula-metad:
    image: vesoft/nebula-metad:v3.8.0
    container_name: graphops-metad
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-metad
      - --ws_ip=nebula-metad
      - --port=9559
      - --ws_http_port=19559
      - --data_path=/data/meta
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    volumes:
      - /ai/GraphOps/docker-data/nebula/meta:/data/meta
      - /ai/GraphOps/docker-data/nebula/meta-logs:/logs
    ports:
      - "9559:9559"
      - "19559:19559"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://nebula-metad:19559/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - graphops-net
    restart: unless-stopped

  nebula-storaged:
    image: vesoft/nebula-storaged:v3.8.0
    container_name: graphops-storaged
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-storaged
      - --ws_ip=nebula-storaged
      - --port=9779
      - --ws_http_port=19779
      - --data_path=/data/storage
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    volumes:
      - /ai/GraphOps/docker-data/nebula/storage:/data/storage
      - /ai/GraphOps/docker-data/nebula/storage-logs:/logs
    ports:
      - "9779:9779"
      - "19779:19779"
    depends_on:
      nebula-metad:
        condition: service_healthy
    # Note: storaged reports unhealthy until ADD HOSTS is run.
    # The start.sh script handles this after graphd is up.
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://nebula-storaged:19779/status"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
    networks:
      - graphops-net
    restart: unless-stopped

  nebula-graphd:
    image: vesoft/nebula-graphd:v3.8.0
    container_name: graphops-graphd
    environment:
      USER: root
    command:
      - --meta_server_addrs=nebula-metad:9559
      - --local_ip=nebula-graphd
      - --ws_ip=nebula-graphd
      - --port=9669
      - --ws_http_port=19669
      - --log_dir=/logs
      - --v=0
      - --minloglevel=0
    volumes:
      - /ai/GraphOps/docker-data/nebula/graphd-logs:/logs
    ports:
      - "9669:9669"
      - "19669:19669"
    depends_on:
      nebula-metad:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://nebula-graphd:19669/status"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - graphops-net
    restart: unless-stopped

  nebula-studio:
    image: vesoft/nebula-graph-studio:v3.10.0
    container_name: graphops-studio
    environment:
      GRAPHD_HOST: nebula-graphd
      GRAPHD_PORT: 9669
    ports:
      - "9788:7001"
    depends_on:
      - nebula-graphd
    networks:
      - graphops-net
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:v1.12.0
    container_name: graphops-qdrant
    volumes:
      - /ai/GraphOps/docker-data/qdrant:/qdrant/storage
    ports:
      - "9333:6333"
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/6333'"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphops-net
    restart: unless-stopped

  redis:
    image: redis:7.2-alpine
    container_name: graphops-redis
    command: redis-server --appendonly yes
    volumes:
      - /ai/GraphOps/docker-data/redis:/data
    ports:
      - "9379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - graphops-net
    restart: unless-stopped

networks:
  graphops-net:
    driver: bridge
